---
title: 'Configure MySQL'
order: 8
keywords: TODO
layout: lesson
sections: []
next: {heading: Next, partial: next}
time_to_complete: 15 minutes
---
Now let's configure MySQL. You'll install the MySQL server and client packages and start the service.

For this part, we'll use the [mysql](https://supermarket.chef.io/cookbooks/mysql) cookbook from Chef Supermarket.

[START_BOX]

## 1. Reference the mysql cookbook

We'll load the `mysql` cookbook just like we did the `selinux`, `firewall`, and `httpd` cookbooks. Append a `depends` statement to <code class="file-path">metadata.rb</code>, making the entire file look like this.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/metadata.rb
name 'awesome_customers_rhel'
maintainer 'The Authors'
maintainer_email 'you@example.com'
license 'all_rights'
description 'Installs/Configures awesome_customers_rhel'
long_description 'Installs/Configures awesome_customers_rhel'
version '0.1.0'

depends 'selinux', '~> 0.9.0'
depends 'firewall', '~> 2.4.0'
depends 'httpd', '~> 0.3.5'
depends 'mysql', '~> 7.0.0'
```

[END_BOX]

[START_BOX]

## 2. Create the database recipe

From your <% fp('~/learn-chef') %> directory, create a recipe named `database` to hold your database configuration code.

```bash
# ~/learn-chef
$ chef generate recipe cookbooks/awesome_customers_rhel database
Installing Cookbook Gems:
Compiling Cookbooks...
Recipe: code_generator::recipe
  * directory[cookbooks/awesome_customers_rhel/spec/unit/recipes] action create (up to date)
  * cookbook_file[cookbooks/awesome_customers_rhel/spec/spec_helper.rb] action create_if_missing (up to date)
  * template[cookbooks/awesome_customers_rhel/spec/unit/recipes/database_spec.rb] action create_if_missing
    - create new file cookbooks/awesome_customers_rhel/spec/unit/recipes/database_spec.rb
    - update content in file cookbooks/awesome_customers_rhel/spec/unit/recipes/database_spec.rb from none to 5fc56b
    (diff output suppressed by config)
  * template[cookbooks/awesome_customers_rhel/recipes/database.rb] action create
    - create new file cookbooks/awesome_customers_rhel/recipes/database.rb
    - update content in file cookbooks/awesome_customers_rhel/recipes/database.rb from none to 6793ff
    (diff output suppressed by config)
```

[END_BOX]

[START_BOX]

## 3. Configure MySQL

Now let's install the MySQL client and service packages. 

Add the following to <code class="file-path">database.rb</code>.

```ruby
# ~/learn-chef/cookbooks/awesome_customers_rhel/recipes/database.rb
# Configure the MySQL client.
mysql_client 'default' do
  action :create
end

# Configure the MySQL service.
mysql_service 'default' do
  initial_root_password node['awesome_customers_rhel']['database']['root_password']
  action [:create, :start]
end
```

The `mysql_client` and `mysql_service` resources come from the `mysql` cookbook. The `mysql_client` resource installs the client software that connects to the MySQL server. The `mysql_service` resource installs the MySQL server package, applies a basic configuration, and starts the service. You can [customize the configuration](https://github.com/chef-cookbooks/mysql#usage) if you need to.

The `mysql_service` resource takes the initial MySQL root password. To specify the password, you use the `node['awesome_customers_rhel']['database']['root_password']` node attribute that you set up in the previous part. When you run the cookbook through Test Kitchen, the password is "mysql\_root_password". When you run the cookbook on a node, the password is randomly generated.

[END_BOX]

[START_BOX]

## 4. Set the database recipe to run

Append an `include_recipe` statement to your default recipe, <code class="file-path">default.rb</code>. The entire file will look like this.

```ruby
include_recipe 'selinux::permissive'
include_recipe 'awesome_customers_rhel::firewall'
include_recipe 'awesome_customers_rhel::web_user'
include_recipe 'awesome_customers_rhel::web'
include_recipe 'awesome_customers_rhel::database'
```

[END_BOX]

[START_BOX]

## 5. Apply and verify the configuration

Let's apply the configuration and verify that MySQL is properly configured. Run `kitchen converge` to apply the `awesome_customers_rhel` cookbook.

```bash
# ~/learn-chef/cookbooks/awesome_customers_rhel
$ kitchen converge
-----> Starting Kitchen (v1.7.2)
-----> Converging <default-centos-72>...
       Preparing files for transfer
       Preparing dna.json
       Resolving cookbook dependencies with Berkshelf 4.3.2...
       Removing non-cookbook files before transfer
       Preparing data_bags
       Preparing secret
       Preparing validation.pem
       Preparing client.rb
-----> Chef Omnibus installation detected (install only if missing)
       Transferring files to <default-centos-72>
       Starting Chef Client, version 12.9.38
       resolving cookbooks for run list: ["awesome_customers_rhel::default"]
       Synchronizing Cookbooks:
         - awesome_customers_rhel (0.1.0)
         - firewall (2.4.0)
         - mysql (7.0.0)
         - selinux (0.9.0)
         - httpd (0.3.5)
         - yum-mysql-community (0.2.0)
         - smf (2.2.8)
         - compat_resource (12.9.1)
         - chef-sugar (3.3.0)
         - rbac (1.0.3)
         - yum (3.10.0)
       Installing Cookbook Gems:
       Compiling Cookbooks...
[...]
       Recipe: awesome_customers_rhel::database
         * mysql_service[default] action create
           * yum_package[default :create mysql-community-server] action install
             - install version 5.5.49-2.el7 of package mysql-community-server
           * yum_package[perl-Sys-Hostname-Long] action nothing (skipped due to action :nothing)
           * execute[Initial DB setup script] action nothing (skipped due to action :nothing)
           * service[default :create mysql] action stop (up to date)
           * service[default :create mysql] action disable (up to date)
           * group[default :create mysql] action create (up to date)
           * user[default :create mysql] action create (up to date)
           * file[default :create /etc/mysql/my.cnf] action delete (up to date)
           * file[default :create /etc/my.cnf] action delete
             - delete file /etc/my.cnf
           * link[default :create /usr/share/my-default.cnf] action create
             - create symlink at /usr/share/my-default.cnf to /etc/mysql-default/my.cnf
           * directory[default :create /etc/mysql-default] action create
             - create new directory /etc/mysql-default
             - change mode from '' to '0750'
             - change owner from '' to 'mysql'
             - change group from '' to 'mysql'
             - restore selinux security context
           * directory[default :create /etc/mysql-default/conf.d] action create
             - create new directory /etc/mysql-default/conf.d
             - change mode from '' to '0750'
             - change owner from '' to 'mysql'
             - change group from '' to 'mysql'
             - restore selinux security context
[...]
       Running handlers:
       Running handlers complete
       Chef Client finished, 31/187 resources updated in 01 minutes 16 seconds
       Finished converging <default-centos-72> (1m21.39s).
-----> Kitchen is finished. (1m22.12s)
```

Now let's verify the database configuration. Start by logging in to your instance.

```bash
# ~/learn-chef/cookbooks/awesome_customers_rhel
$ kitchen login
Last login: Mon Apr 25 18:31:55 2016 from 10.0.2.2
[vagrant@default-centos-72 ~]$
```

First, verify that the MySQL service is running.

```bash
[vagrant@default-centos-72 ~]$ sudo netstat -tap | grep mysql
tcp        0      0 0.0.0.0:mysql           0.0.0.0:*               LISTEN      28435/mysqld
```

You'll see that the `mysqld` service is in the `LISTEN` state.

Now verify that you can access the databases that come preconfigured with the installation. Recall that for local development using Test Kitchen, you provided "mysql\_root_password" as the MySQL root password.

```bash
[vagrant@default-centos-72 ~]$ mysqlshow -h 127.0.0.1 -uroot -pmysql_root_password
+--------------------+
|     Databases      |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
```

Looks good! Now log out.

```bash
# ~
[vagrant@default-centos-72 ~]$ logout
Connection to 127.0.0.1 closed.
```

[END_BOX]
