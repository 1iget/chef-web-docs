##Deploying a cookbook

Chef cookbooks use the same deployment pipeline as applications. Here is the workflow for cookbooks.

![](skills/continuous-availability-at-ibm/cookbook_workflow.png)

The Jenkins slave agents run in SoftLayer, the public cloud, because SoftLayer can provide bare-metal nodes. This capability means there is no need for nested virtualization, which is not currently available in the private cloud.

###Versioned roles

The team began their work before Chef developed [policy files](https://docs.chef.io/config_rb_policyfile.html), so they used a technique called versioned roles to pin particular cookbooks to particular environments. With versioned roles, you use role names that include a version number. This way the team can be selective about the changes each environment receives and, for the production environment, which is made up of seven cloud regions, they can keep different clouds at different versions. The UCD tool allows them to keep an inventory of which clouds are associated with which roles.
Here is the workflow for roles.

![](skills/continuous-availability-at-ibm/role_workflow.png)

The following screenshot is an example of how the UCD inventory keeps track of a subset of the versioned roles across different private cloud regions.

![](skills/continuous-availability-at-ibm/ucd_screenshot.png)

Jenkins, in combination with [scmversion](https://github.com/RiotGamesMinions/thor-scmversion), takes care of naming the roles and of incrementing the version number. UCD updates the [run-list](https://docs.chef.io/run_lists.html) on the node to set it to that versioned role.

UCD deploys versioned roles to both the public and private cloud. It also modifies the node attributes on the Chef server. UCD does this by overriding the run list and converging the node.

Brian explains the approach. "Overriding the run list on the node is how UCD and Chef work together to set a node to a new desired state. This ensures that Chef and UCD are always on the same page about the desired state of a node."

The following diagram shows the UCD process.

![](skills/continuous-availability-at-ibm/ucd_roles.png)

The process performs the following steps.


1.	A set of artifacts that is generated by Jenkins is downloaded. The artifacts describe the role and version to be updated as a properties file.
2.	The properties are read and made available to the subsequent steps.
3.	A global lock is acquired for the Chef client that runs on the target node. The lock prevents multiple updates from clashing with each other. (The lock is automatically released when the workflow finishes.)
4.	A regular expression and substitution is applied to replace run list items, which, in this case, are the role versions.
5.	The node is converged.
