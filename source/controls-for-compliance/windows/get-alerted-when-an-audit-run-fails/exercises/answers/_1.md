```ruby
# ~/chef-repo/cookbooks/webserver/recipes/default.rb
# Block ICMPv4 and ICMPv6 Echo Request messages in the public profile.
[{:name => 'ICMPv4', :type => 8,}, {:name => 'ICMPv6', :type => 128 }].each { |protocol|
  powershell_script "Block #{protocol[:name]} Echo Request messages" do
    code <<-EOH
      Get-NetFirewallPortFilter -Protocol #{protocol[:name]} |
      Where-Object { $_.IcmpType -eq #{protocol[:type]} } |
      Get-NetFirewallRule |
      Where-Object {
        ($_.Profile -eq "Public") -and
        ($_.Direction -eq "Inbound") -and
        ($_.Action -eq "Allow") } |
      Set-NetFirewallRule -Action Block -Enabled True
    EOH
    guard_interpreter :powershell_script
    not_if <<-EOH
      (Get-NetFirewallPortFilter -Protocol #{protocol[:name]} |
      Where-Object { $_.IcmpType -eq #{protocol[:type]} } |
      Get-NetFirewallRule |
      Where-Object {
        ($_.Profile -eq "Public") -and
        ($_.Direction -eq "Inbound") -and
        ($_.Enabled -eq "True") -and
        ($_.Action -eq "Block") } |
      Measure-Object).Count -gt 0
    EOH
  end
}
```

```ruby
# ~/chef-repo/cookbooks/audit/recipes/default.rb
control_group 'Validate network configuration and firewalls' do
  [{:name => 'ICMPv4', :type => 8,}, {:name => 'ICMPv6', :type => 128 }].each { |protocol|
    control "Ensure the firewall blocks public #{protocol[:name]} Echo Request messages" do
      it 'has at least one rule that blocks access' do
        expect(command(<<-EOH
          (Get-NetFirewallPortFilter -Protocol #{protocol[:name]} |
          Where-Object { $_.IcmpType -eq #{protocol[:type]} } |
          Get-NetFirewallRule |
          Where-Object {
            ($_.Profile -eq "Public") -and
            ($_.Direction -eq "Inbound") -and
            ($_.Enabled -eq "True") -and
            ($_.Action -eq "Block") } |
          Measure-Object).Count -gt 0
          EOH
        ).stdout).to match(/True/)
      end
    end
  }
end
```
