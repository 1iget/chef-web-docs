---
title: 'NTP'
order: 1
deprecates: 'http://wiki.opscode.com/display/chef/Guide+to+Creating+A+Cookbook+and+Writing+A+Recipe'
---

NTP with Chef
=============
One of the most common problems for system administrators is ensuring system time is correct. Thankfully, we have the [NTP project](http://www.ntp.org/) to help alleviate this problem. In this guide, we will setup NTP using Chef on a Vagrant instance.

---

##### Create the ntp cookbook
To get started, we need to create the `ntp` cookbook. We can use the knife command to generate this scaffolding for us:

    $ knife cookbook create ntp

This will generate a folder in the `cookbooks` directory of your repository with many subdirectories.

---

##### Name the Recipe
1. Recipe names directly correspond to directory structure:

  ![Chef run_list to Directory Mapping](run-list-directory-structure.png)

  [INFO] A recipe is a *subset* or "piece" of a cookbook.

1. There is also a special recipe in every cookbook called `default.rb`. It is executed by default when the recipe is executed:

        # These are functionally equivalent:

        recipe[ntp] => cookbooks/ntp/recipes/default.rb # implicit
        recipe[ntp::default] => cookbooks/ntp/recipes/default.rb # explicit

For simplicity in this guide, we will just use the `default` recipe, but it is common practice to use multiple recipes to separate functionality for a specific cookbook, such as "client" vs "server".

---

##### Write the Recipe
In the default recipe `recipes/default.rb`, add the following:

1. Install the NTP package. The package provider is built into Chef - it will check to see the running operating system and use the appropriate method (yum, apt, etc):

    ```ruby
    package 'ntp'
    ```

1. Next we need to write out the NTP configuration template using Chef's Template provider:

    ```ruby
    template '/etc/ntp.conf' do
      source    'ntp.conf.erb'
      notifies  :restart, 'service[ntpd]'
    end
    ```

1. Finally, alert Chef of the service and start it:

    ```ruby
    service 'ntpd' do
      action [:enable, :start]
    end
    ```

1. Your final recipe should look like this:

    ```ruby
    package 'ntp'

    template '/etc/ntp.conf' do
      source    'ntp.conf.erb'
      notifies  :restart, 'service[ntpd]'
    end

    service 'ntpd' do
      action [:enable, :start]
    end
    ```

---

##### Create the Template
Create a new file in `templates/default/ntp.conf.erb` (since that's what we provided to the source attribute in the previous step) and add the following:

```bash
# This file was generated by Chef for '<%= node['fqdn'] %>'.
# Do NOT edit this file by hand!

restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict -6 ::1
server '0.pool.ntp.org'
server  127.127.1.0     # local clock
driftfile /var/lib/ntp/drift
keys /etc/ntp/keys
```

---

##### Wrap Up
There are some final (and optional depending on your setup) steps:

1. Commit these changes to git (if you're using git or scm)
1. Upload this cookbook to the Chef Server (if you're using Hosted or Private Chef)
1. Look on the community site:

  [WARN] If you look on the [community site](https://community.opscode.com) you'll see there's already an [NTP cookbook](https://community.opscode.com/cookbooks/ntp). Oh no!

  This brings up an important rule in the Chef world - **always check the community site first** before writing your own cookbook. The community cookbook is much more feature-complete than the one we've written and is designed to fit more use cases. While this cookbook serves as a great learning process, always check the community site before developing your own cookbook.
