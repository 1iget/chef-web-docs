---
title: 'Remediate the compliance failure on a local virtual machine'
order: 2
keywords: TODO
layout: lesson
sections: []
time_to_complete: 60 minutes
next: {heading: Next, partial: next}
---
Recall that in the previous tutorial you ran the **cis-centos7-level1** compliance profile and that it failed the **Set SSH Protocol to 2** rule.

![](compliance/scan_report_issues_sshv2_centos7.png)

The failure tells us that the node potentially enables [SSH version 1 connections](https://en.wikipedia.org/wiki/Secure_Shell#SSH-1). CIS recommends that you disable access through SSH-1 because it has design flaws that make it vulnerable.

In this part, you'll verify the failure of the **Set SSH Protocol to 2** rule on a local virtual machine and remediate it. By starting with local development, you can verify configuration changes on temporary test instances before you apply the updated configuration to your production servers.

You can configure Test Kitchen to download and run compliance profiles on your test instances. For example, you can pull compliance profiles from [Chef Supermarket](https://docs.chef.io/supermarket.html), a Git repository, or from your Chef compliance scanner server. Here, you'll configure Test Kitchen to download the **cis-centos7-level1** profile from your Chef compliance scanner server.

Here's what you'll do:

1. [Understand the compliance failure](#step1)
1. [Install kitchen-inspec](#step2)
1. [Login to the Chef compliance scanner through the InSpec CLI](#step3)
1. [Create the ssh cookbook](#step4)
1. [Replicate the failure on your Test Kitchen instance](#step5)
1. [Remediate the failure](#step6)

[START_BOX]

### 1. Understand the compliance failure

Let's take a closer look at what the **Set SSH Protocol to 2** rule checks for.

From the **Compliance** menu in the Chef compliance scanner web interface, select the **CIS CentOS Linux 7 Benchmark Level 1** profile. Then scroll to the **Set SSH Protocol to 2** rule. You'll see this:

![](compliance/ssh_protocol_2_rule.png)

The code you see is [InSpec](http://inspec.io), an auditing and testing framework that's built on the Ruby programming language. If you're familiar with testing frameworks such as [RSpec](http://rspec.info) and [Serverspec](http://serverspec.org), InSpec code will look familiar to you.

InSpec provides [built-in resource types](http://inspec.io/docs/reference/resources/) that describe the various parts of a system, such as files, users, and services. In this example, you see the [file](http://inspec.io/docs/reference/resources/file) resource used 2 times.

The first `file` resource uses a regular expression to verify whether the SSH configuration file, <% fp '/etc/ssh/sshd_conf' %>, contains at least one occurence of the `Protocol` setting. The regular expression does not match any settings that begin with a comment `#`.

The second `file` resource uses the same regular expression, but uses the [capture group](http://www.regular-expressions.info/refcapture.html) `(\S+)` to verify that each occurence of the `Protocol` setting specifies 2 as its value.

[COMMENT] [Learn more about regular expressions in Ruby](http://www.tutorialspoint.com/ruby/ruby_regular_expressions.htm). Then see the regular expression in action. Go to [rubular.com](http://rubular.com) and enter the regular expression `^\s*Protocol\s+(\S+)\s*(?:#.*)?$`. Then test it against a few strings and note the behavior. Some strings you might test against are `Protocol 2,1`, `# Protocol 2`, and `Protocol 2 # only 2`.

When you scanned your CentOS node, you saw that the first `file` resource failed.

![](compliance/scan_report_issues_sshv2_centos7.png)

This means that the `Protocol` setting is not provided. The recommendation is to explicitly set the `Protocol` to version 2 only.

Let's connect to your node and compare the contents of <% fp '/etc/ssh/sshd_conf' %> to the rule.

You can connect using the private key you created in the previous tutorial. Here's an example.

```bash
$ ssh -i ~/.ssh/node1 vagrant@192.168.77.78
Last login: Fri Apr 15 13:11:09 2016 from 192.168.77.1
```

Now search <% fp '/etc/ssh/sshd_config' %> for the string "Protocol". This example also prints the 3 lines that precede and follow any matches.

```bash
[vagrant@node-1 ~]$ cat /etc/ssh/sshd_config | grep Protocol -B 3 -A 3
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   Port 22
#   Protocol 2,1
#   Cipher 3des
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,arcfour256,arcfour128,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160
```

Your output may differ, but in this example the line `#   Protocol 2,1` appears in the file. However, the line begins with a comment `#` character. Recall that the regular expression does not match commented settings.

Now that you better understand why the rule failed, you can begin to write Chef code to remediate the failure.

[END_BOX]

[START_BOX]

## 2. Install kitchen-inspec

Later in this part, you'll scan a test instance against the CIS profile through Test Kitchen. To do so, you need the `kitchen-inspec` gem. `kitchen-inspec` is a plugin that enables you to run InSpec tests from Test Kitchen.

Install `kitchen-inspec` like this.

```bash
# ~/learn-chef
$ chef gem install kitchen-inspec
Fetching: kitchen-inspec-0.13.0.gem (100%)
Successfully installed kitchen-inspec-0.13.0
1 gem installed
```

[END_BOX]

[START_BOX]

## 3. Login to the Chef compliance scanner through the InSpec CLI

To download compliance profiles from your Chef compliance scanner server, `kitchen-inspec` requires login credentials.

To do so, you run the `inspec compliance login` command. The [inspec](http://inspec.io/docs/reference/cli/) command-line interface (CLI) utility comes with the Chef DK.

To login from the CLI, you first need an authorization token. To get that, select **About** from the menu located at the upper-right corner.in the web interface.

![](compliance/webui_about.png)

Then copy the contents of the **Refresh token** field to the clipboard.

![](compliance/webui_token.png)

Next, run this command to connect InSpec to your Chef compliance scanner server. Replace <% ph 'FQDN' %> with your Chef compliance scanner server's FQDN, <% ph 'USER' %> with the username you use to login to the Chef compliance scanner web interface, and <% ph 'TOKEN' %> with your authorization token.

```bash
# ~/learn-chef
$ inspec compliance login https://FQDN --user USER --insecure --refresh_token 'TOKEN'
```

Here's an example:

```bash
# ~/learn-chef
$ inspec compliance login https://chef-compliance.local --user john-smith --insecure --refresh_token '2/Ksux-Hx7UVilz6PFOray5od0HK70rVr8MJhdyGUwVV4ypelVBkGsgHXla0RpLZybCtBzuSuJgK4NkoWq7a1qNA=='
Successfully authenticated
```

[COMMENT] The `--insecure` flag bypasses SSL verification because Chef compliance scanner comes with a self-signed certificate. In a production environment, you can [configure an SSL certificate](https://docs.chef.io/install_compliance.html#configure-ssl) that's rooted by a trusted certificate authority (CA) and omit the `--insecure` flag.

As a verification step, you can run `inspec compliance profiles` to prove that you've successfully authenticated.

```bash
# ~/learn-chef
$ inspec compliance profiles
Available profiles:
-------------------
 * base/apache
 * base/linux
 * base/mysql
 * base/postgres
 * base/ssh
 * base/windows
 * cis/cis-centos6-level1
 * cis/cis-centos6-level2
 * cis/cis-centos7-level1
 * cis/cis-centos7-level2
 * cis/cis-rhel6-level1
 * cis/cis-rhel6-level2
 * cis/cis-rhel7-level1
 * cis/cis-rhel7-level2
 * cis/cis-ubuntu12.04lts-level1
 * cis/cis-ubuntu12.04lts-level2
 * cis/cis-ubuntu14.04lts-level1
 * cis/cis-ubuntu14.04lts-level2
```

[END_BOX]

[START_BOX]

## 4. Create the ssh cookbook

To remediate the failure, you'll write a Chef cookbook named `ssh`. Recall that a cookbook provides structure to your Chef code. A cookbook contains recipes, which in turn contain resources that descibe the desired state of the system.

In this part, you create the `ssh` cookbook. Although initially empty, in the next step you apply the cookbook to a CentOS 7 instance using Test Kitchen to verify that the instance comes up and successfully runs `chef-client`.

To get started, first move to the <% fp('~/learn-chef') %> directory.

```bash
# ~
$ cd ~/learn-chef
```

Ensure that you have a directory named <% fp('~/learn-chef/cookbooks') %>.

```bash
# ~/learn-chef
$ mkdir cookbooks
```

Run the following `chef generate cookbook` command to create the `ssh` cookbook.

```bash
# ~/learn-chef
$ chef generate cookbook cookbooks/ssh
Compiling Cookbooks...
Recipe: code_generator::cookbook
  * directory[/Users/user/learn-chef/cookbooks/ssh] action create
    - create new directory /Users/user/learn-chef/cookbooks/ssh
[...]
  * cookbook_file[/Users/user/learn-chef/cookbooks/ssh/.gitignore] action create
    - create new file /Users/user/learn-chef/cookbooks/ssh/.gitignore
    - update content in file /Users/user/learn-chef/cookbooks/ssh/.gitignore from none to dd37b2
    (diff output suppressed by config)
```

[END_BOX]

[START_BOX]

## 4. Apply the ssh cookbook on a Test Kitchen instance

Now you'll verify that the empty cookbook runs successfully on a CentOS 7 test instance. Replace the contents of your copy of <% fp('~/learn-chef/cookbooks/ssh/.kitchen.yml') %> with this.

```yaml
# ~/learn-chef/cookbooks/ssh/.kitchen.yml
---
driver:
  name: vagrant

provisioner:
  name: chef_zero

verifier:
  name: inspec
  inspec_tests:
    - compliance://cis/cis-centos7-level1

platforms:
  - name: centos-7.2

suites:
  - name: default
    run_list:
      - recipe[ssh::default]
    attributes:
```

This configuration uses the Vagrant driver and brings up a CentOS 7.2 instance. The `verifier` section tells Test Kitchen to look for InSpec tests. More on that later.

Next, from your terminal, move to the <% fp('~/learn-chef/cookbooks/ssh') %> directory.

```bash
# ~/learn-chef
$ cd ~/learn-chef/cookbooks/ssh
```

Run `kitchen list`. You'll see that the instance is not yet created.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen list
Instance           Driver   Provisioner  Verifier  Transport  Last Action
default-centos-72  Vagrant  ChefZero     Inspec    Ssh        <Not Created>
```

Now run `kitchen converge`. This command downloads the base CentOS 7.2 box if needed, brings up an instance, installs `chef-client`, and applies the `ssh` cookbook.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen converge
-----> Starting Kitchen (v1.7.3)
-----> Creating <default-centos-72>...
       Bringing machine 'default' up with 'virtualbox' provider...
       ==> default: Importing base box 'bento/centos-7.2'...
[...]
       resolving cookbooks for run list: ["ssh::default"]
       Synchronizing Cookbooks:
         - ssh (0.1.0)
       Installing Cookbook Gems:
       Compiling Cookbooks...
       Converging 0 resources

       Running handlers:
       Running handlers complete
       Chef Client finished, 0/0 resources updated in 01 seconds
       Finished converging <default-centos-72> (0m23.75s).
-----> Kitchen is finished. (1m2.06s)
```

As expected, 0 resources were applied because the cookbook is empty. But it's a great first step to verifying that the instance comes up and `chef-client` runs successfully.

[END_BOX]

[START_BOX]

## 5. Replicate the failure on your Test Kitchen instance

In the previous tutorial, you saw the SSH-2 rule fail on your node. It's a good idea to verify that the rule also fails on your Test Kitchen instance before you write remediation code.

Recall that the InSpec code for the rule looks like this. This rule comes from the **cis/cis-centos7-level1** profile.

![](compliance/ssh_protocol_2_rule.png)

Also recall that your <% fp '.kitchen.yml' %> file looks like this.

```yaml
# ~/learn-chef/cookbooks/ssh/.kitchen.yml
---
driver:
  name: vagrant

provisioner:
  name: chef_zero

verifier:
  name: inspec
  inspec_tests:
    - compliance://cis/cis-centos7-level1

platforms:
  - name: centos-7.2

suites:
  - name: default
    run_list:
      - recipe[ssh::default]
    attributes:
```

The `inspec_tests` part tells Test Kitchen to download and run the **cis/cis-centos7-level1** profile from Chef compliance scanner when it runs tests. You specified your Chef compliance scanner server when you ran `inspec compliance login` earlier.

You're now ready to scan your test instance. Run `kitchen verify` to run the compliance profile.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen verify
-----> Starting Kitchen (v1.7.3)
-----> Setting up <default-centos-72>...
       Finished setting up <default-centos-72> (0m0.00s).
-----> Verifying <default-centos-72>...
       Detected alternative framework tests for `inspec`
[...]
Finished in 9.11 seconds (files took 12.7 seconds to load)
529 examples, 166 failures, 8 pending

Failed examples:

rspec  # File /etc/ssh/sshd_config content should match /^\s*Protocol\s+(\S+)\s*(?:#.*)?$/
rspec  # Mount /tmp should be mounted
rspec  # Mount /tmp should be mounted
[...]
>>>>>> Verify failed on instance <default-centos-72>.
>>>>>> Please see .kitchen/logs/default-centos-72.log for more details
>>>>>> ------Exception-------
>>>>>> Class: Kitchen::ActionFailed
>>>>>> Message: Inspec Runner returns 1
>>>>>> ----------------------
```

When you scanned your node from the web interface, you likely noticed that many tests fail the CIS recommendations. You'll see a similar number of failures when you run the same tests against your test instance.

For now, we're only interested in seeing the **Set SSH Protocol to 2** rule fail. We're working to make it easier to pinpoint specific failures in the output. For now, run `kitchen verify` a second time and redirect the output to a text file, like this.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen verify > verify.txt 2>&1
```

You can locate the status of a test by searching for code from that test. The **Set SSH Protocol to 2** rule contains this matcher:

> should match /^\s\*Protocol\s+(\S+)\s\*(?:#.\*)?$/

From a text editor, search <% fp 'verify.txt' %> for this string. Or run this command if you have access to the `grep` utility.

```bash
# ~/learn-chef/cookbooks/ssh
$ cat verify.txt | grep '\d*).*should match /^\\s\*Protocol'
  71) File /etc/ssh/sshd_config content should match /^\s*Protocol\s+(\S+)\s*(?:#.*)?$/
```

You see that the error appears in the output. You can investigate the output further for more details.

Now that you've replicated the failure on a test instance, you can write Chef code to remediate it.

[END_BOX]

[START_BOX]

## 6. Remediate the failure

In practice, you and your team would decide the appropriate way to fix the error. For example, you might use the [file](https://docs.chef.io/resource_file.html), [cookbook_file](https://docs.chef.io/resource_cookbook_file.html), or [template](https://docs.chef.io/resource_template.html) resource to provide a complete replacement to <% fp '/etc/ssh/sshd_config' %>.


For learning purposes, you'll use the `cookbook_file` resource to provide an SSH configuration file that contains only the `Protocol` setting.

The first step is to add a file to your cookbook that contains the configuration settings. Start by moving to the <% fp '~/learn-chef' %> directory.

```bash
# ~/learn-chef/cookbooks/ssh
$ cd ~/learn-chef
```

Run this command to add a file named <% fp 'ssh_config' %> to your cookbook.

```bash
# ~/learn-chef
$ chef generate file cookbooks/ssh ssh_config
```

Now write the contents of your configuration file, <% fp '~/learn-chef/cookbooks/ssh/files/default/sshd_config' %>. The new configuration file includes only the `Protocol` setting and uses the recommended value of 2.

```ruby
# ~/learn-chef/cookbooks/ssh/files/default/sshd_config
Protocol 2
```

Now write your default recipe, <% fp '~/learn-chef/cookbooks/ssh/recipes/default.rb' %>. The default recipe uses the `cookbook_file` resource to copy the contents of the <% fp 'sshd_config' %> file in your cookbook to <% fp '/etc/ssh/sshd_config' %> on your test instance.

```ruby
# ~/learn-chef/cookbooks/ssh/recipes/default.rb
cookbook_file '/etc/ssh/sshd_config' do
  source 'sshd_config'
  owner 'root'
  group 'root'
  mode '0644'
end
```

Next, move back to your cookbook's directory.

```bash
# ~/learn-chef
$ cd ~/learn-chef/cookbooks/ssh
```

Run `kitchen converge` to apply the configuration.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen converge
-----> Starting Kitchen (v1.7.3)
-----> Converging <default-centos-72>...
       Preparing files for transfer
       Preparing dna.json
       Resolving cookbook dependencies with Berkshelf 4.3.2...
       Removing non-cookbook files before transfer
       Preparing validation.pem
       Preparing client.rb
-----> Chef Omnibus installation detected (install only if missing)
       Transferring files to <default-centos-72>
       Starting Chef Client, version 12.9.41
       resolving cookbooks for run list: ["ssh::default"]
       Synchronizing Cookbooks:
         - ssh (0.1.0)
       Installing Cookbook Gems:
       Compiling Cookbooks...
       Converging 1 resources
       Recipe: ssh::default
         * cookbook_file[/etc/ssh/sshd_config] action create
           - update content in file /etc/ssh/sshd_config from 648219 to 09447b
           --- /etc/ssh/sshd_config	2016-04-28 11:36:35.816000000 +0000
           +++ /etc/ssh/.chef-sshd_config20160511-16395-m0n0e2	2016-05-11 15:22:50.065363256 +0000
           @@ -1,155 +1,2 @@
           -#	$OpenBSD: sshd_config,v 1.93 2014/01/10 05:59:19 djm Exp $
           -
           -# This is the sshd server system-wide configuration file.  See
           -# sshd_config(5) for more information.
[...]
           -UseDNS no
           +Protocol 2
           - change mode from '0600' to '0644'
           - restore selinux security context

       Running handlers:
       Running handlers complete
       Chef Client finished, 1/1 resources updated in 01 seconds
       Finished converging <default-centos-72> (0m3.28s).
-----> Kitchen is finished. (0m5.33s)
```

You see from the output that the contents of <% fp '/etc/ssh/sshd_config' %> were changed.

Now run `kitchen verify` to run the compliance profile a second time.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen verify > verify.txt 2>&1
```

Repeat the step where you search <% fp 'verify.txt' %> for the string "should match /^\s\*Protocol\s+(\S+)\s\*(?:#.\*)?$/".

```bash
# ~/learn-chef/cookbooks/ssh
$ cat verify.txt | grep '\d*).*should match /^\\s\*Protocol'
```

Success! The output no longer contains the failure. This gives you confidence that the SSH-2 rule would pass after this cookbook is applied to your node.

If the test were to fail, you would examine the failure, modify your cookbook to try something else, and then run `kitchen converge` to apply the change followed by `kitchen verify` to run your compliance scan.

[COMMENT] Test Kitchen instances are meant to be disposable. If you place your test instance in an unrepairable state or want to start over, run `kitchen destroy` to destroy your instance followed by `kitchen converge` to bring up a new one. The copy of your cookbook on your workstation is unaffected.

As a final verification step, you can login to your test instance and verify that the SSH configuration file contains the expected protocol setting.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen login
Last login: Wed May 11 15:22:47 2016 from 10.0.2.2
[vagrant@default-centos-72 ~]$ cat /etc/ssh/sshd_config
Protocol 2
[vagrant@default-centos-72 ~]$ logout
Connection to 127.0.0.1 closed.
```

When you're finished, run `kitchen destroy` to tear down your test instance.

```bash
# ~/learn-chef/cookbooks/ssh
$ kitchen destroy
-----> Starting Kitchen (v1.7.3)
-----> Destroying <default-centos-72>...
       ==> default: Forcing shutdown of VM...
       ==> default: Destroying VM and associated drives...
       Vagrant instance <default-centos-72> destroyed.
       Finished destroying <default-centos-72> (0m4.75s).
-----> Kitchen is finished. (0m6.97s)
```

[END_BOX]
